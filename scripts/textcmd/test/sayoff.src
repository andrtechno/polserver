use uo;
use unicode;

include "util/bank";
include "include/string";
include ":gumps:gumps";
include ":gumps:gumps_ex";

program textcmd_sayoff(who)
    SendSysMessageUC(who, "Укажите персонажа.", "RUS", color := 88);

	var targ := Target(who, TGTOPT_NOCHECK_LOS);
	if (!targ)
        SendSysMessageUC(who, "Отмена.", "RUS", color := 33);
		return;
	endif

	if (targ.isA(POLCLASS_NPC))
        SendSysMessageUC(who, "Это не персонаж.", "RUS", color := 33);
		return;
	endif

    if(targ.cmdlevel > 0)
        SendSysMessageUC(who, "Отмена.", "RUS", color := 33);
		return;
    endif

    var isSay := GetObjProperty(targ, "CmdSay");

    if(isSay)

        var x := 10;
        var y := 15;
        var gump := GFCreateGump( 20, 50 );
        GFClosable(gump, 1);
        var widthGump := 250;
        var heightGump := 100;
        GFResizePic( gump, 0, 0, GFGetCfgConst("Defaults", "ForeGround"), widthGump, heightGump);


        if(isSay.enabled)
            GFAddButton(gump, 10, 20, 2117, 2118, GF_CLOSE_BTN, 100);
            GFTextLine(gump,  30, 17, 2100, "Отключить чат" );

            GFAddButton(gump, 10, 40, 2117, 2118, GF_CLOSE_BTN, 200);
            GFTextLine(gump,  30, 40, 2100, "Обнулить очки штрафа" );
        else
            var owner := SystemFindObjectBySerial(CInt(isSay.disableOwner));

            GFAddButton(gump, 10, 20, 2117, 2118, GF_CLOSE_BTN, 300);
            GFTextLine(gump, 30, 15, 67, "Включить чат" );

            GFTextLine(gump, 15, 40, 2100, "Отключил: (" +owner.acctname+"/" +owner.name+")");
        endif
        GFTextLine(gump, 15, 70, 33, "Очков штрафа: " +CInt(isSay.penalty));

        var input := GFSendGump( who, gump );
        input := CInt(input[0]);
        if (input == 100)
            var data := struct;
            data.+enabled := 0;
            data.+penalty := CInt(isSay.penalty) + 1;
            data.+disableOwner := who.serial;
            SetObjProperty(targ, "CmdSay", data);
            SendSysMessageUC(who, "Чат успешно заблокирован.", "RUS", 3, 67);
            SendSysMessageUC(targ, "Ваш чат заблокирован.", "RUS", color := 33);
        elseif(input == 200)
            var data := struct;
            data.+enabled := isSay.enabled;
            data.+penalty := 0;
            data.+disableOwner := isSay.disableOwner;
            SetObjProperty(who, "CmdSay", data);
            SendSysMessageUC(who, "Очки штрафа обнулины.", "RUS", 3, 33);
        endif

    else
       SendSysMessageUC(who, "Чат еще небыл активен", "RUS", 3, 33);
    endif


    return 1;
endprogram
