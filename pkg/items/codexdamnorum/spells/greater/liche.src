use uo;
use os;

include ":charclasses:classes";
include "include/client";
include ":attributes:attributes";
include ":codexdamnorum:spelldata";
include "include/statMod";

program cast_liche( parms )

	set_script_option( SCRIPTOPT_CAN_ACCESS_OFFLINE_MOBILES, 1 );

	//var circle := GetCircle( SPELLID_LICHE );
	var circle := 78;
	var plane := 0x10;
	var caster;
	var fromhit;

    //if (!CheckCastSpot(caster, info))
    //    return 0;
    //endif
	if ( GetObjProperty(caster, "Polymorph") )
        SendSysMessage(caster,"Already under the influence!");
		return 0;
	endif


	if (parms[1] == "#MOB")
		caster := parms[2];
		if (parms[4])
			circle := parms[4];
		endif
		if (parms[5])
			fromhit := parms[5];
		endif
		if( GetObjProperty( caster, "IsLiche" ) )
			return;
		endif

	else
		caster := parms;
		if( GetObjProperty( caster, "IsLiche" ) )
			SendSysMessage( caster, "You're already a liche." );
			EraseObjProperty( caster, "#Casting" );
			return;
		endif
	
		//var result := TryToCast( caster, SPELLID_LICHE );
		//if( result != SUCCESS )
			//if( result == NO_SKILL )
				//BurnSelf( caster, circle );
				//PlayObjectCenteredEffect( caster, FX_SPELL_LICHE, SPEED_SPELL_LICHE, LOOP_SPELL_LICHE );
				//PlaySoundEffect( caster, LICHE_KILL_SOUND );
			//endif
		
			//EraseObjProperty( caster, "#Casting" );
			//return;
		//endif
	endif

	/*if( !CanMod(caster, "poly") )
		EraseObjProperty( caster, "#Casting" );
		SendSysMessage( caster, "You're already polymorphed in something." );
		return;
	endif*/

    var magery     := CInt(GetAttribute(caster, MAGERY));
    var mod_amount := GetModAmount( magery );
    var duration := GetModDuration( magery );

    var info := parms[2];

    if(GetObjProperty(caster,"classid") == ID_MAGE)
        var val := (info.classlevel * 10);
        mod_amount := RandomIntMinMax(val, (val + 10));
        duration := 60 * val;
    endif
	duration := 50;
    var graphic := caster.graphic;
    var color := caster.color;
	TS_StartTimer(caster, "Liche", duration, mod_amount, {graphic, color});
	return 1;
endprogram

function fixcolor(who)

	var newcolor, racepicked := who.title_race;

	if (racepicked=="Elf")
		newcolor := 770;
	elseif (racepicked=="Dark-Elf")
		newcolor := 33877;
	elseif (racepicked=="Goblin")
		newcolor := 34186;
	elseif (racepicked=="Barbarian")
		newcolor := 33804;
	elseif (racepicked=="Dwarf")
		newcolor := 33888;
	else
		newcolor := who.truecolor;
	endif

	who.color := newcolor;

endfunction